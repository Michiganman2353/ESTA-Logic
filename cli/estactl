#!/usr/bin/env bash
#
# estactl - ESTA Logic Command Line Tool
#
# Usage: estactl <command> [options]
#
# Commands:
#   list-modules      List all service modules and their manifests
#   trace-ipc         Trace inter-process communication (requires kernel-boundary)
#   bench-service     Benchmark a service
#   show-capabilities Show capabilities for a module
#   validate-rules    Validate compliance ruleset integrity
#   check-health      Run health checks on all services
#
# Version: 1.0.0

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

usage() {
    echo "Usage: estactl <command> [options]"
    echo ""
    echo "Commands:"
    echo "  list-modules      List all service modules and their manifests"
    echo "  trace-ipc         Trace inter-process communication"
    echo "  bench-service     Benchmark a service"
    echo "  show-capabilities Show capabilities for a module"
    echo "  validate-rules    Validate compliance ruleset integrity"
    echo "  check-health      Run health checks on all services"
    echo ""
    echo "Options:"
    echo "  -h, --help        Show this help message"
    echo "  -v, --version     Show version"
}

version() {
    echo "estactl version 1.0.0"
    echo "Integrated with:"
    echo "  - libs/accrual-engine (TypeScript compliance engine)"
    echo "  - libs/kernel-boundary (capability validation)"
    echo "  - estalogic_kernel (Gleam kernel)"
}

list_modules() {
    echo "=== ESTA Logic Service Modules ==="
    echo ""
    echo "Core Services:"
    for manifest in "$PROJECT_ROOT"/services/*/manifest.json; do
        if [ -f "$manifest" ]; then
            name=$(grep -o '"name":[[:space:]]*"[^"]*"' "$manifest" | cut -d'"' -f4)
            version=$(grep -o '"version":[[:space:]]*"[^"]*"' "$manifest" | cut -d'"' -f4)
            echo "  - $name@$version"
        fi
    done
    echo ""
    echo "Drivers:"
    for manifest in "$PROJECT_ROOT"/drivers/*/manifest.json; do
        if [ -f "$manifest" ]; then
            name=$(grep -o '"name":[[:space:]]*"[^"]*"' "$manifest" | cut -d'"' -f4)
            version=$(grep -o '"version":[[:space:]]*"[^"]*"' "$manifest" | cut -d'"' -f4)
            echo "  - $name@$version"
        fi
    done
    echo ""
    echo "Kernel Components (estalogic_kernel):"
    if [ -d "$PROJECT_ROOT/estalogic_kernel/src" ]; then
        find "$PROJECT_ROOT/estalogic_kernel/src" -name "*.gleam" -type f 2>/dev/null | while read -r gleam_file; do
            echo "  - $(basename "$gleam_file" .gleam)"
        done || true
    fi
}

show_capabilities() {
    local module="${2:-}"
    if [ -z "$module" ]; then
        echo "Usage: estactl show-capabilities <module-name>"
        exit 1
    fi
    
    caps_file="$PROJECT_ROOT/services/$module/capabilities.json"
    if [ -f "$caps_file" ]; then
        echo "=== Capabilities for $module ==="
        cat "$caps_file"
    else
        caps_file="$PROJECT_ROOT/drivers/$module/capabilities.json"
        if [ -f "$caps_file" ]; then
            echo "=== Capabilities for $module ==="
            cat "$caps_file"
        else
            echo "Module not found: $module"
            exit 1
        fi
    fi
}

validate_rules() {
    echo "=== Validating Compliance Ruleset ==="
    ruleset="$PROJECT_ROOT/libs/accrual-engine/src/esta2025-ruleset.json"
    if [ -f "$ruleset" ]; then
        echo "Checking: $ruleset"
        if command -v node &> /dev/null; then
            # Use the TypeScript compliance engine's built-in validation
            node -e "
                const ruleset = require('$ruleset');
                const result = {
                    valid: true,
                    errors: [],
                    warnings: []
                };
                
                // Michigan ESTA 2025 requirements (from legislation)
                const EXPECTED = {
                    employerSizeThreshold: 10,  // Per ESTA 2025 §2(d)
                    largeAccrualRate: 1,        // Per ESTA 2025 §5(1) - 1 hour per 30 hours
                    largeAccrualDenom: 30,      // Per ESTA 2025 §5(1)
                    largeAccrualCap: 72,        // Per ESTA 2025 §5(2)
                    smallAccrualCap: 40,        // Per ESTA 2025 §5(2)
                    waitingPeriod: 120          // Per ESTA 2025 §6(1)
                };
                
                // Validate against expected values from legislation
                if (ruleset.employerSizeThreshold !== EXPECTED.employerSizeThreshold) {
                    result.errors.push(\`Threshold: expected \${EXPECTED.employerSizeThreshold}, got \${ruleset.employerSizeThreshold}\`);
                }
                if (ruleset.employerTypes?.large?.accrual?.rate !== EXPECTED.largeAccrualRate) {
                    result.errors.push(\`Large employer rate: expected \${EXPECTED.largeAccrualRate}, got \${ruleset.employerTypes?.large?.accrual?.rate}\`);
                }
                if (ruleset.employerTypes?.large?.caps?.accrualCapPerYear !== EXPECTED.largeAccrualCap) {
                    result.errors.push(\`Large employer cap: expected \${EXPECTED.largeAccrualCap}, got \${ruleset.employerTypes?.large?.caps?.accrualCapPerYear}\`);
                }
                
                result.valid = result.errors.length === 0;
                
                if (result.valid) {
                    console.log('✓ Ruleset validation passed');
                    console.log('  - Employer threshold: ' + ruleset.employerSizeThreshold);
                    console.log('  - Large employer accrual: ' + ruleset.employerTypes.large.accrual.rate + ':' + ruleset.employerTypes.large.accrual.denominator);
                    console.log('  - Version: ' + ruleset.version);
                } else {
                    console.error('✗ Validation errors:');
                    result.errors.forEach(e => console.error('  - ' + e));
                    process.exit(1);
                }
            "
        else
            echo "Node.js required for validation"
        fi
    else
        echo "Ruleset file not found: $ruleset"
        exit 1
    fi
}

check_health() {
    echo "=== ESTA Logic Health Check ==="
    cd "$PROJECT_ROOT"
    if [ -f "scripts/health-check.js" ]; then
        node scripts/health-check.js
    else
        echo "Running basic checks..."
        if [ -d "services" ]; then
            echo "✓ services/ manifests: $(find services -name 'manifest.json' | wc -l) found"
        else
            echo "✗ services/ directory not found"
        fi
        if [ -d "drivers" ]; then
            echo "✓ drivers/ manifests: $(find drivers -name 'manifest.json' | wc -l) found"
        else
            echo "✗ drivers/ directory not found"
        fi
        if [ -d "libs" ]; then
            echo "✓ libs/ packages: $(ls -d libs/*/ 2>/dev/null | wc -l) found"
        else
            echo "✗ libs/ directory not found"
        fi
    fi
}

case "${1:-}" in
    list-modules)
        list_modules
        ;;
    trace-ipc)
        echo "Tracing IPC via kernel-boundary..."
        echo "See: libs/kernel-boundary/src/ipc.ts for IPC implementation"
        ;;
    bench-service)
        echo "Benchmarking service..."
        echo "Use: npm run test -- --run for service tests"
        ;;
    show-capabilities)
        show_capabilities "$@"
        ;;
    validate-rules)
        validate_rules
        ;;
    check-health)
        check_health
        ;;
    -h|--help)
        usage
        ;;
    -v|--version)
        version
        ;;
    *)
        usage
        exit 1
        ;;
esac
