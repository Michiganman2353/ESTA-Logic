# Skip hooks in CI environments or when HUSKY=0
if [ "$CI" = "true" ] || [ "$HUSKY" = "0" ]; then
    echo "Skipping pre-push hooks in CI environment"
    exit 0
fi

# Verify branch is not diverged from main/master (prevents merge conflicts)
BASE_BRANCH=""
if git fetch origin main --quiet 2>/dev/null && git rev-parse origin/main >/dev/null 2>&1; then
    BASE_BRANCH="origin/main"
elif git fetch origin master --quiet 2>/dev/null && git rev-parse origin/master >/dev/null 2>&1; then
    BASE_BRANCH="origin/master"
fi

if [ -n "$BASE_BRANCH" ]; then
    if ! git merge-base --is-ancestor "$BASE_BRANCH" HEAD 2>/dev/null; then
        echo "Warning: Your branch has diverged from $BASE_BRANCH."
        echo "Consider running 'git pull --rebase $BASE_BRANCH' before pushing."
    fi
else
    echo "Note: Unable to fetch origin/main or origin/master - skipping divergence check."
fi

# Lint affected files before push
if [ -n "$BASE_BRANCH" ] && git rev-parse "$BASE_BRANCH" >/dev/null 2>&1; then
    nx affected --target=lint --base="$BASE_BRANCH" || {
        echo "Linting failed - please fix lint errors before pushing"
        exit 1
    }
else
    echo "Note: No base branch available for affected lint - running full lint"
    nx run-many --target=lint --all || {
        echo "Linting failed - please fix lint errors before pushing"
        exit 1
    }
fi
