name: run-firestore-emulator
description: Start Firestore emulator for tests
inputs:
  port:
    description: 'Port to run the Firestore emulator on'
    required: false
    default: '8080'
  java_heap_size:
    description: 'Java heap size for the emulator (e.g., 512m, 1g)'
    required: false
    default: '512m'
outputs:
  emulator_pid:
    description: 'PID of the emulator process'
    value: ${{ steps.start-emulator.outputs.pid }}
  emulator_port:
    description: 'Port the emulator is running on'
    value: ${{ steps.start-emulator.outputs.port }}
runs:
  using: 'composite'
  steps:
    - name: Install dependencies
      shell: bash
      run: |
        # Install netcat and lsof for port checking and cleanup
        sudo apt-get update -qq
        sudo apt-get install -y -qq netcat-openbsd lsof || {
          echo "âš ï¸ Failed to install some dependencies, attempting fallback..."
          sudo apt-get install -y -qq netcat lsof 2>/dev/null || true
        }
        echo "âœ… Dependencies installed"

    - name: Cleanup stale emulator processes
      shell: bash
      env:
        EMULATOR_PORT: ${{ inputs.port }}
      run: |
        # Kill any existing emulator processes
        pkill -f "firebase.*emulators" || true

        # Use lsof to clear ports 8080 and 8085 (common emulator ports)
        for PORT in 8080 8085 ${EMULATOR_PORT}; do
          PID=$(lsof -t -i:${PORT} 2>/dev/null || true)
          if [ -n "${PID}" ]; then
            echo "âš ï¸ Killing process ${PID} on port ${PORT}"
            kill ${PID} 2>/dev/null || true
            sleep 1
            # Force kill if still running
            kill -9 ${PID} 2>/dev/null || true
          fi
        done

        # Wait for ports to be released
        sleep 2
        echo "âœ… Port cleanup complete"

    - name: Start emulator
      id: start-emulator
      shell: bash
      env:
        EMULATOR_PORT: ${{ inputs.port }}
        JAVA_HEAP_SIZE: ${{ inputs.java_heap_size }}
      run: |
        # Check if port is already in use and find alternative
        PORT=${EMULATOR_PORT}
        MAX_PORT_ATTEMPTS=5
        for attempt in $(seq 1 ${MAX_PORT_ATTEMPTS}); do
          if nc -z 127.0.0.1 ${PORT} 2>/dev/null; then
            echo "âš ï¸ Port ${PORT} is in use, trying next port..."
            PORT=$((PORT + 1))
          else
            break
          fi
        done

        if [ ${PORT} -ne ${EMULATOR_PORT} ]; then
          echo "Using alternative port: ${PORT}"
        fi

        # Install firebase-tools if not available
        if ! command -v firebase &> /dev/null; then
          echo "ðŸ“¦ Installing firebase-tools..."
          if ! npm i -g firebase-tools; then
            echo "âŒ Failed to install firebase-tools"
            exit 1
          fi
          echo "âœ… firebase-tools installed"
        fi

        # Verify firebase is available
        if ! command -v firebase &> /dev/null; then
          echo "âŒ firebase command not available after installation"
          exit 1
        fi

        # Start emulator with Java options for stability
        export JAVA_TOOL_OPTIONS="-Xmx${JAVA_HEAP_SIZE}"
        nohup firebase emulators:start --only firestore --project test-project --host 127.0.0.1 --port ${PORT} > firestore-emulator.log 2>&1 &
        EMULATOR_PID=$!
        echo "pid=${EMULATOR_PID}" >> $GITHUB_OUTPUT
        echo "port=${PORT}" >> $GITHUB_OUTPUT

        # Wait for emulator to accept connections with timeout
        echo "â³ Waiting for Firestore emulator on port ${PORT}..."
        TIMEOUT=45
        for i in $(seq 1 ${TIMEOUT}); do
          if nc -z 127.0.0.1 ${PORT} 2>/dev/null; then
            echo "âœ… Firestore emulator is ready on port ${PORT} (PID: ${EMULATOR_PID})"
            exit 0
          fi
          # Check if process is still running
          if ! kill -0 ${EMULATOR_PID} 2>/dev/null; then
            echo "âŒ Emulator process died unexpectedly"
            cat firestore-emulator.log || true
            exit 1
          fi
          sleep 1
        done

        echo "âŒ Timeout waiting for Firestore emulator"
        cat firestore-emulator.log || true
        exit 1

    - name: Export cleanup info
      if: always()
      shell: bash
      run: |
        # Document cleanup for consumers of this action
        # GitHub Actions terminates all processes when the job ends, but consumers
        # can use the emulator_pid output to kill the emulator earlier if needed:
        #   kill ${{ steps.start-emulator.outputs.pid }} 2>/dev/null || true
        EMU_PID="${{ steps.start-emulator.outputs.pid }}"
        if [ -n "${EMU_PID}" ]; then
          echo "âœ… Emulator running with PID: ${EMU_PID}"
          echo "   To stop manually: kill ${EMU_PID}"
        fi
